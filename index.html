<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Pedidos de Avaliação - JJK RPG</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Roboto+Mono:wght@400;700&family=Yuji+Syuku&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #0c0c1a;
      --panel: #13141c;
      --muted: #bfc6e6;
      --accent1: #2979ff;
      --highlight: #82b1ff;
      --text: #e7e9ff;
      --ui: 'Inter', system-ui, sans-serif;
      --title: 'Yuji Syuku', serif;
      --mono: 'Roboto Mono', monospace;
      --glass: rgba(255, 255, 255, 0.03);
      --glass-2: rgba(255, 255, 255, 0.02);
      --success: #00e091;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: var(--ui);
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    #form-container {
      background: var(--panel);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    #output-container {
      background: var(--panel);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px;
    }
    fieldset {
      border: 1px solid var(--glass);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    legend {
      font-family: var(--title);
      font-size: 1.5em;
      color: var(--highlight);
      padding: 0 10px;
      margin-left: 10px;
    }
    .grid-2 { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 15px; 
    }
    .grid-3 { 
      display: grid; 
      grid-template-columns: 1fr 1fr 1fr; 
      gap: 15px; 
    }
    .input-group { 
      display: flex; 
      flex-direction: column; 
      gap: 5px; 
      margin-bottom: 10px; 
    }
    label { 
      font-weight: 500; 
      font-size: 13px; 
      color: var(--muted); 
      text-transform: uppercase; 
      font-family: var(--mono); 
    }
    input[type="text"], input[type="url"], textarea, select {
      background: var(--bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 10px;
      color: var(--text);
      font-family: var(--ui);
      font-size: 14px;
    }
    select { font-family: var(--mono); }
    textarea { 
      min-height: 80px; 
      resize: vertical; 
    }
    .note { 
      font-size: 12px; 
      color: var(--muted); 
      opacity: 0.8; 
      margin-top: -5px; 
      margin-bottom: 10px; 
    }
    #output-code {
      width: 100%;
      height: 200px;
      background: var(--bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      resize: vertical;
      margin-bottom: 10px;
    }
    #copy-btn {
      width: 100%; 
      padding: 12px; 
      border: none; 
      border-radius: 8px; 
      background: var(--success);
      color: var(--panel); 
      font-size: 1em; 
      font-family: var(--ui); 
      font-weight: 700;
      cursor: pointer; 
      transition: background 0.2s;
    }
    #copy-btn:hover { 
      background: #00ffaa; 
    }
    
    textarea::-webkit-scrollbar { 
      width: 8px; 
    }
    textarea::-webkit-scrollbar-track { 
      background: var(--panel); 
    }
    textarea::-webkit-scrollbar-thumb { 
      background-color: var(--accent1); 
      border-radius: 8px; 
    }
    
    @media (max-width: 600px) {
      .grid-2, .grid-3 { 
        grid-template-columns: 1fr; 
      }
      body {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    
    <div id="form-container">
      <fieldset>
        <legend>Informações do Pedido</legend>
        <div class="grid-2">
          <div class="input-group">
            <label for="f-jogador">Jogador</label>
            <input type="text" id="f-jogador" placeholder="Seu nome de usuário">
          </div>
          <div class="input-group">
            <label for="f-personagem">Personagem</label>
            <input type="text" id="f-personagem" placeholder="Nome do personagem">
          </div>
        </div>
        
        <div class="grid-3">
          <div class="input-group">
            <label for="f-tipo">Tipo de Atividade</label>
            <select id="f-tipo">
              <option value="Missão">Missão</option>
              <option value="Quest">Quest</option>
              <option value="Evento">Evento</option>
              <option value="Treino">Treino</option>
            </select>
          </div>
          <div class="input-group">
            <label for="f-grau">Grau/Nível da Atividade</label>
            <select id="f-grau">
              <option value="Grau 4">Grau 4</option>
              <option value="Grau 3">Grau 3</option>
              <option value="Grau 2">Grau 2</option>
              <option value="Grau 1">Grau 1</option>
              <option value="Semi-Especial">Semi-Especial</option>
              <option value="Especial">Especial</option>
            </select>
          </div>
          <div class="input-group">
            <label for="f-status-inimigos">Barra de Status Inimigos?</label>
            <select id="f-status-inimigos">
              <option value="Sim">Sim</option>
              <option value="Não">Não</option>
            </select>
          </div>
        </div>
        
        <div class="input-group">
          <label for="f-participantes">Participantes</label>
          <input type="text" id="f-participantes" placeholder="Lista de jogadores participantes">
        </div>
        
        <div class="input-group">
          <label for="f-objetivo">Objetivo da Atividade</label>
          <textarea id="f-objetivo" placeholder="Qual será o objetivo desta atividade? O que vocês pretendem alcançar?"></textarea>
          <div class="note">Descreva o objetivo que vocês pretendem alcançar com esta atividade</div>
        </div>

        <div class="input-group">
          <label for="f-resumo">Resumo das Atividades Anteriores</label>
          <textarea id="f-resumo" placeholder="O que os personagens fizeram ANTES de iniciar esta nova atividade?"></textarea>
          <div class="note">Descreva o que aconteceu com os personagens antes desta atividade que está sendo solicitada</div>
        </div>

        <div class="input-group">
          <label for="f-roteiro">Sugestão de Roteiro</label>
          <textarea id="f-roteiro" placeholder="Sua sugestão de como a atividade pode se desenvolver"></textarea>
        </div>

        <div class="input-group">
          <label for="f-fichas">Links das Fichas dos Participantes</label>
          <textarea id="f-fichas" placeholder="Cole um link por linha. Serão formatados automaticamente na mesma linha."></textarea>
          <div class="note">Cole um link por linha. Os links serão formatados automaticamente e aparecerão na mesma linha, separados por vírgulas</div>
        </div>
      </fieldset>
    </div>

    <div id="output-container">
      <textarea id="output-code" readonly>O código do seu pedido de avaliação aparecerá aqui...</textarea>
      <button id="copy-btn">Copiar Código</button>
    </div>
  </div>

  <script>
    // --- SCRIPT PRINCIPAL ---
    document.addEventListener('DOMContentLoaded', function() {
      
      const form = document.getElementById('form-container');
      const copyBtn = document.getElementById('copy-btn');
      const outputArea = document.getElementById('output-code');
      const allInputs = form.querySelectorAll('input, textarea, select');
      const storageKey = 'pedidoAvaliacaoData_v3';

      // --- FUNÇÕES UTILITÁRIAS ---
      function getVal(id) { 
        const element = document.getElementById(id);
        return element ? element.value.trim() : ''; 
      }
      
      function escapeHTML(str) { 
        if (!str) return ''; 
        return str.replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
      }
      
      function escapeAttr(str) { 
        if (!str) return ''; 
        return str.replace(/"/g, "&quot;"); 
      }

      // --- PROCESSAMENTO DOS LINKS DAS FICHAS ---
      function processarLinksFichas(texto) {
        if (!texto.trim()) return 'Nenhum link fornecido';
        
        const linhas = texto.split('\n').filter(linha => linha.trim());
        if (linhas.length === 0) return 'Nenhum link fornecido';
        
        const linksFormatados = linhas.map(linha => {
          const url = linha.trim();
          // Extrair nome do personagem da URL ou usar texto padrão
          let nome = 'Ficha';
          try {
            // Tentar extrair informação útil da URL
            const urlObj = new URL(url);
            const caminho = urlObj.pathname;
            // Se houver algo no caminho que pareça um nome, usar isso
            const partes = caminho.split('/').filter(part => part && part.length > 2);
            if (partes.length > 0) {
              nome = partes[partes.length - 1].replace(/-/g, ' ').replace(/%20/g, ' ');
            }
          } catch (e) {
            // Se não for uma URL válida, usar o texto cru
            nome = 'Ficha do Participante';
          }
          
          return `[url=${url}]${nome}[/url]`;
        });
        
        // Juntar todos os links na mesma linha, separados por vírgulas
        return linksFormatados.join(', ');
      }

      // --- SISTEMA DE ALTURA DO IFRAME ---
      const targetOrigin = 'https://goldenagejjkrpg.forumeiros.com';
      
      function sendHeight() {
        const newHeight = document.documentElement.scrollHeight;
        console.log('Enviando altura para o fórum:', newHeight + 'px');
        window.parent.postMessage({ frameHeight: newHeight }, targetOrigin);
      }

      const resizeObserver = new ResizeObserver(entries => {
        sendHeight();
      });
      resizeObserver.observe(document.body);

      // --- GERAÇÃO DO CÓDIGO ---
      function generateAndDisplayCode() {
        try {
          const jogador = escapeHTML(getVal('f-jogador'));
          const personagem = escapeHTML(getVal('f-personagem'));
          const tipo = escapeHTML(getVal('f-tipo'));
          const grau = escapeHTML(getVal('f-grau'));
          const statusInimigos = escapeHTML(getVal('f-status-inimigos'));
          const participantes = escapeHTML(getVal('f-participantes'));
          const objetivo = escapeHTML(getVal('f-objetivo'));
          const resumo = escapeHTML(getVal('f-resumo'));
          const roteiro = escapeHTML(getVal('f-roteiro'));
          const fichasTexto = getVal('f-fichas');
          const fichasFormatadas = processarLinksFichas(fichasTexto);

          // Template atualizado com todas as correções
          const codigoTemplate = `<link href="https://gaaaaaaaaabs.github.io/goldenagerepositor.io/combate.css" rel="stylesheet" type="text/css"> <div class="avaliacao-request"> <div class="avaliacao-header"> <div class="avaliacao-title"> <h3>PEDIDO DE AVALIAÇÃO</h3> <span class="avaliacao-status" data-status="1">Status: Aguardando Avaliação</span> </div> </div> <div class="avaliacao-content"> <div class="avaliacao-field"> <span class="avaliacao-label">Jogador:</span> <span class="avaliacao-value">${jogador || 'SeuNomeAqui'}</span> </div> <div class="avaliacao-field"> <span class="avaliacao-label">Personagem:</span> <span class="avaliacao-value">${personagem || 'NomeDoPersonagem'}</span> </div> <div class="avaliacao-field"> <span class="avaliacao-label">Tipo de Atividade:</span> <span class="avaliacao-value">${tipo || 'Tipo de Atividade'}</span> </div> <div class="avaliacao-field"> <span class="avaliacao-label">Grau/Nível:</span> <span class="avaliacao-value">${grau || 'Grau da Atividade'}</span> </div> <div class="avaliacao-field"> <span class="avaliacao-label">Barra de Status Inimigos:</span> <span class="avaliacao-value">${statusInimigos || 'Não informado'}</span> </div> <div class="avaliacao-field"> <span class="avaliacao-label">Participantes:</span> <span class="avaliacao-value">${participantes || 'Lista de participantes'}</span> </div> <div class="avaliacao-field full-width"> <span class="avaliacao-label">Objetivo da Atividade:</span> <span class="avaliacao-value">${objetivo || 'Objetivo da atividade...'}</span> </div> <div class="avaliacao-field full-width"> <span class="avaliacao-label">Resumo das Atividades Anteriores:</span> <span class="avaliacao-value">${resumo || 'Resumo das atividades anteriores...'}</span> </div> <div class="avaliacao-field full-width"> <span class="avaliacao-label">Sugestão de Roteiro:</span> <span class="avaliacao-value">${roteiro || 'Sugestão de roteiro não fornecida'}</span> </div> <div class="avaliacao-field"> <span class="avaliacao-label">Fichas dos Participantes:</span> <span class="avaliacao-value">${fichasFormatadas}</span> </div> </div> <div class="avaliacao-footer"> <div class="avaliacao-master"> <b>Avaliador Responsável:</b> <span style="color: #82b1ff;">Aguardando designação</span> </div> <div class="avaliacao-notes"> <b>Feedback do Avaliador:</b> <span style="color: #82b1ff;">Aguardando avaliação.</span> </div> </div> </div> <style> .avaliacao-request { background: linear-gradient(135deg, #1a1a2e 0%, #0c0c1a 100%); border: 2px solid #2979ff; border-radius: 10px; margin: 15px 0; overflow: hidden; color: #e7e9ff; font-family: Arial, sans-serif; } .avaliacao-header { background: rgba(41, 121, 255, 0.2); padding: 15px 20px; border-bottom: 1px solid #333; } .avaliacao-title { display: flex; justify-content: space-between; align-items: center; } .avaliacao-title h3 { margin: 0; color: #82b1ff; font-size: 1.3em; } .avaliacao-status { background: #2979ff; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold; } .avaliacao-content { padding: 20px; } .avaliacao-field { display: flex; margin-bottom: 12px; align-items: flex-start; } .avaliacao-field.full-width { flex-direction: column; } .avaliacao-label { font-weight: bold; width: 140px; flex-shrink: 0; color: #bfc6e6; } .avaliacao-value { color: #82b1ff; flex: 1; } .avaliacao-field.full-width .avaliacao-value { margin-top: 5px; background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 4px; border-left: 3px solid #2979ff; } .avaliacao-footer { background: rgba(0, 0, 0, 0.3); padding: 12px 20px; border-top: 1px solid #333; text-align: center; } .avaliacao-master { color: #bfc6e6; font-size: 0.95em; margin-bottom: 8px; } .avaliacao-notes { color: #bfc6e6; font-size: 0.95em; } </style>`;

          outputArea.value = codigoTemplate;
        
        } catch (e) {
          console.error("Erro ao gerar código:", e);
          outputArea.value = "Erro! Verifique os valores do formulário.";
        }
      }
      
      // --- SALVAMENTO LOCAL ---
      function saveDataToLocalStorage() {
        const data = {};
        allInputs.forEach(input => {
          if(input.id) {
            data[input.id] = input.value;
          }
        });
        localStorage.setItem(storageKey, JSON.stringify(data));
      }

      function loadDataFromLocalStorage() {
        try {
          const data = JSON.parse(localStorage.getItem(storageKey));
          if (data) {
            allInputs.forEach(input => {
              if (input.id && data[input.id] !== undefined) {
                input.value = data[input.id];
              }
            });
          }
        } catch (e) {
          console.log('Nenhum dado salvo encontrado');
        }
        generateAndDisplayCode();
      }

      // --- INICIALIZAÇÃO ---
      function initialize() {
        // Carrega dados salvos
        loadDataFromLocalStorage();
        
        // Configura eventos
        form.addEventListener('input', function() {
          generateAndDisplayCode();
          saveDataToLocalStorage();
          sendHeight(); 
        });

        copyBtn.addEventListener('click', function() {
          outputArea.select();
          document.execCommand('copy');
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copiado!';
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 2000);
        });
        
        // Envia altura inicial
        setTimeout(sendHeight, 100);
      }

      // Inicializa a aplicação
      initialize();

    });
  </script>
</body>
</html>
